name: Proxy Scanner

on:
  workflow_dispatch:

jobs:
  scan-proxies:
    runs-on: ubuntu-latest

    steps:
      - name: Repo'yu çek
        uses: actions/checkout@v4

      - name: Python kur
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Gerekli paketleri kur
        run: pip install requests

      - name: Proxy tarama döngüsü
        run: |
          echo "=== 40 defalık proxy tarama döngüsü başlıyor ==="
          
          # Proxy tarayıcı kodu
          cat << 'EOF' > pro.py
          import requests
          import concurrent.futures
          import threading

          PROXY_LIST_URL = "https://raw.githubusercontent.com/ProxyScraper/ProxyScraper/refs/heads/main/http.txt"
          TARGET_TEST_URL = "https://cloudflare.com/cdn-cgi/trace"

          working_proxies = []
          lock = threading.Lock()
          stop_testing = False
          MAX_PROXY = 20

          def get_proxies():
              txt = requests.get(PROXY_LIST_URL, timeout=10).text
              proxies = [line.strip() for line in txt.split("\n") if ":" in line]
              return proxies

          def test_proxy(proxy):
              global stop_testing
              if stop_testing:
                  return
              proxies = {"http": f"http://{proxy}", "https": f"http://{proxy}"}
              try:
                  r = requests.get(TARGET_TEST_URL, proxies=proxies, timeout=2)
                  if r.status_code == 200:
                      with lock:
                          if len(working_proxies) < MAX_PROXY:
                              working_proxies.append(proxy)
                              if len(working_proxies) >= MAX_PROXY:
                                  stop_testing = True
              except:
                  pass

          def main():
              proxies = get_proxies()
              with concurrent.futures.ThreadPoolExecutor(max_workers=600) as executor:
                  executor.map(test_proxy, proxies)
              with open("pro.txt", "w") as f:
                  for p in working_proxies:
                      f.write(p + "\n")

          if __name__ == "__main__":
              main()
          EOF

          # 40 defalık döngü
          for i in $(seq 1 40); do
            echo "=== Döngü $i ==="
            python pro.py

            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add pro.txt
            git commit -m "Auto-update pro.txt - iteration $i" || echo "No changes"
            git push

            echo "=== 5 dakika bekleniyor ==="
            sleep 300
          done

          echo "=== 40 döngü tamamlandı, workflow kendini tetikleyecek ==="

          # Kendini tetikle (master branch)
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/proxy-scanner.yml/dispatches \
            -d '{"ref":"master"}'

          echo "Workflow tetiklendi, mevcut workflow sonlanıyor."
