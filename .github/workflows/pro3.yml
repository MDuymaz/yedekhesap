name: Proxy Scanner Loop

on:
  workflow_dispatch:

jobs:
  scan-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6 saat sınır: 5 saatlik döngü için güvenli

    steps:
      - name: Repo'yu çek
        uses: actions/checkout@v4

      - name: Python kur
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Proxy tarayıcı kodunu oluştur
        run: |
          cat << 'EOF' > pro_loop.py
          import requests
          import concurrent.futures
          import threading
          import time
          import subprocess

          PROXY_LIST_URL = "https://raw.githubusercontent.com/ProxyScraper/ProxyScraper/refs/heads/main/http.txt"
          TARGET_TEST_URL = "https://cloudflare.com/cdn-cgi/trace"
          MAX_PROXY = 20

          def get_proxies():
              txt = requests.get(PROXY_LIST_URL, timeout=10).text
              return [line.strip() for line in txt.split("\n") if ":" in line]

          def test_proxy(proxy, working_proxies, lock, stop_flag):
              if stop_flag["stop"]:
                  return

              proxies = {"http": f"http://{proxy}", "https": f"http://{proxy}"}

              try:
                  r = requests.get(TARGET_TEST_URL, proxies=proxies, timeout=2)
                  if r.status_code == 200:
                      with lock:
                          if len(working_proxies) < MAX_PROXY:
                              working_proxies.append(proxy)
                              if len(working_proxies) >= MAX_PROXY:
                                  stop_flag["stop"] = True
              except:
                  pass

          def scan_once():
              lock = threading.Lock()
              stop_flag = {"stop": False}
              working = []

              proxies = get_proxies()

              with concurrent.futures.ThreadPoolExecutor(max_workers=500) as executor:
                  executor.map(lambda p: test_proxy(p, working, lock, stop_flag), proxies)

              with open("pro.txt", "w") as f:
                  for p in working:
                      f.write(p + "\n")

          def git_push():
              subprocess.run(["git", "config", "user.name", "GitHub Actions"])
              subprocess.run(["git", "config", "user.email", "actions@github.com"])
              subprocess.run(["git", "add", "pro.txt"])
              subprocess.run(["git", "commit", "-m", "Auto-update 20 proxies"], stderr=subprocess.DEVNULL)
              subprocess.run(["git", "pull", "--rebase", "--autostash"])
              subprocess.run(["git", "push"])

          def main():
              start = time.time()
              FIVE_HOURS = 5 * 60 * 60

              while time.time() - start < FIVE_HOURS:
                  print("[*] Yeni tarama başlatılıyor...")
                  scan_once()
                  git_push()
                  print("[*] 20 proxy kaydedildi, 5 dakika bekleniyor...")
                  time.sleep(300)  # 5 dakika bekle

          if __name__ == "__main__":
              main()
          EOF

      - name: Gerekli paketler
        run: pip install requests

      - name: Döngülü tarayıcıyı çalıştır
        run: python pro_loop.py
