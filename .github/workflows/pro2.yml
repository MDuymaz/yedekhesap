name: 5-Hour Proxy Scanner

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"   # Her 5 dakikada bir

jobs:
  run-loop:
    runs-on: ubuntu-latest

    steps:
      - name: Repo'yu çek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Python kur
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: loop.py oluştur
        run: |
          cat << 'EOF' > loop.py
          import time
          import requests
          import concurrent.futures
          import threading
          import subprocess
          import os

          PROXY_LIST_URL = "https://raw.githubusercontent.com/ProxyScraper/ProxyScraper/refs/heads/main/http.txt"
          TARGET_TEST_URL = "https://cloudflare.com/cdn-cgi/trace"
          MAX_PROXY = 20

          # -----------------------------
          def get_proxies():
              txt = requests.get(PROXY_LIST_URL, timeout=10).text
              return [line.strip() for line in txt.split("\n") if ":" in line]

          # -----------------------------
          def test_proxy(proxy, working, lock):
              proxies = {"http": f"http://{proxy}", "https": f"http://{proxy}"}
              try:
                  r = requests.get(TARGET_TEST_URL, proxies=proxies, timeout=2)
                  if r.status_code == 200:
                      with lock:
                          if len(working) < MAX_PROXY:
                              working.append(proxy)
              except:
                  pass

          # -----------------------------
          def run_scan():
              working = []
              lock = threading.Lock()

              proxies = get_proxies()
              with concurrent.futures.ThreadPoolExecutor(max_workers=600) as ex:
                  for p in proxies:
                      ex.submit(test_proxy, p, working, lock)

              # proxy dosyasını temiz yaz
              with open("pro.txt", "w") as f:
                  for p in working:
                      f.write(p + "\n")

              # olası merge marker temizliği
              with open("pro.txt", "r") as f:
                  lines = f.readlines()

              cleaned = [
                  l for l in lines
                  if ":" in l
                  and not l.startswith("<<<<<<<")
                  and not l.startswith("=======")
                  and not l.startswith(">>>>>>>")
              ]

              with open("pro.txt", "w") as f:
                  f.writelines(cleaned)

              return len(working)

          # -----------------------------
          print("[*] Proxy taraması başlıyor...")
          count = run_scan()
          print(f"[*] {count} çalışan proxy bulundu.")

          print("[*] Git commit hazırlanıyor...")

          subprocess.run(["git", "config", "user.name", "GitHub Actions"])
          subprocess.run(["git", "config", "user.email", "actions@github.com"])

          # çatışma çıkarsa pro.txt tamamen bizim olsun
          subprocess.run(["git", "checkout", "--ours", "pro.txt"], stderr=subprocess.DEVNULL)

          subprocess.run(["git", "add", "pro.txt"])
          subprocess.run(["git", "commit", "-m", "Auto-update pro.txt"], stderr=subprocess.DEVNULL)
          subprocess.run(["git", "pull", "--rebase"], stderr=subprocess.DEVNULL)
          subprocess.run(["git", "push"], stderr=subprocess.DEVNULL)

          print("[✓] Güncellendi ve push edildi.")
          EOF

      - name: Gerekli paketler
        run: pip install requests

      - name: Çalıştır
        run: python loop.py
