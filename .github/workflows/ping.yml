name: Ping
on:
  schedule:
    - cron: "* */3 * * *"
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: 5 saat boyunca her 10 dakikada bir ping at (19:00‚Äì23:00 arasƒ± cache atlama)
        env:
          
          PING_URL1: ${{ secrets.PING_URL1 }}
          PING_URL2: ${{ secrets.PING_URL2 }}
          PING_URL3: ${{ secrets.PING_URL3 }}    
          PING_URL4: ${{ secrets.PING_URL4 }}  
          PING_XTREAM1: ${{ secrets.PING_XTREAM1 }}
          PING_XTREAM2: ${{ secrets.PING_XTREAM2 }}
          PING_CACHE_URL1: ${{ secrets.PING_CACHE_URL1 }}
          PING_CACHE_URL2: ${{ secrets.PING_CACHE_URL2 }}
          PING_CACHE_URL3: ${{ secrets.PING_CACHE_URL3 }}
        run: |
          # jq yoksa y√ºkle
          if ! command -v jq &> /dev/null; then
            echo "jq y√ºkleniyor..."
            sudo apt-get update && sudo apt-get install -y jq
          fi

          END_TIME=$((SECONDS + 5 * 60 * 60))

          while [ $SECONDS -lt $END_TIME ]; do
            # Normal URL ping
            for URL_NAME in PING_URL1 PING_URL2 PING_URL3 PING_URL4 PING_XTREAM1 PING_XTREAM2; do
              URL=${!URL_NAME}
              echo "üîÑ $URL_NAME i√ßin ping atƒ±lƒ±yor: $URL - $(date '+%Y-%m-%d %H:%M:%S' -u)"
              
              HTML=$(curl -s "$URL")
              TEXT=$(echo "$HTML" | grep -oP '(?<=<h1>).*?(?=</h1>)')

              if [[ -z "$TEXT" ]]; then
                echo "‚ùå $URL_NAME sistemi pasif olabilir!"
              else
                echo "‚úÖ $URL_NAME: $TEXT"
              fi
            done

            echo "‚è≥ 10 dakika bekleniyor..."
            sleep 600
          done

          echo "‚úÖ 5 saatlik normal ping i≈ülemleri tamamlandƒ±."

          # T√ºrkiye saati (GMT+3)
          CURRENT_HOUR=$(TZ="Europe/Istanbul" date +%H)

          if (( 19 <= 10#$CURRENT_HOUR && 10#$CURRENT_HOUR < 23 )); then
            echo "üïñ ≈ûu an T√ºrkiye saatiyle $CURRENT_HOUR:00 ‚Äî cache ping atlanƒ±yor."
          else
            echo "üïò Cache ping zamanƒ± ‚Äî T√ºrkiye saatiyle $CURRENT_HOUR:00"

            for CACHE_NAME in PING_CACHE_URL1 PING_CACHE_URL2 PING_CACHE_URL3; do
              CACHE_URL=${!CACHE_NAME}
              echo "üîÑ $CACHE_NAME cache ping atƒ±lƒ±yor: $CACHE_URL - $(date '+%Y-%m-%d %H:%M:%S' -u)"
              
              CACHE_HTML=$(curl -s "$CACHE_URL")
              CACHE_TEXT=$(echo "$CACHE_HTML" | jq -r '.message')

              if [[ -z "$CACHE_TEXT" || "$CACHE_TEXT" == "null" ]]; then
                echo "‚ùå $CACHE_NAME cache sistemi pasif olabilir!"
              else
                echo "‚úÖ $CACHE_NAME cache: $CACHE_TEXT"
              fi
            done
          fi
